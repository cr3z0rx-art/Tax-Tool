<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FitPlanner Pro Ultra</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root { --p:#27ae60; --a:#e67e22; --bg:#f8f9fa; --card:#fff; --text:#333; }
[data-theme="dark"] { --bg:#121212; --card:#1e1e1e; --text:#eee; }

body {
  margin:0; font-family:system-ui;
  background:var(--bg); color:var(--text);
  padding:15px; transition:.3s;
}

.header {
  display:flex; justify-content:space-between;
  align-items:center; margin-bottom:10px;
}

.dashboard {
  background:linear-gradient(135deg,var(--p),#2ecc71);
  padding:20px; border-radius:22px;
  color:white; text-align:center;
}

.action-grid {
  display:grid; grid-template-columns:1fr 1fr;
  gap:15px; margin-top:15px;
}

.action-card {
  background:var(--card); padding:20px;
  border-radius:18px; text-align:center;
  cursor:pointer;
  box-shadow:0 4px 6px rgba(0,0,0,0.05);
}

.panel {
  display:none; background:var(--card);
  margin-top:20px; padding:20px;
  border-radius:22px;
  animation:fadeIn .3s;
}

@keyframes fadeIn {
  from {opacity:0; transform:translateY(10px);}
  to {opacity:1; transform:translateY(0);}
}

.btn {
  width:100%; padding:14px;
  border:none; border-radius:12px;
  background:var(--p); color:white;
  font-weight:bold; cursor:pointer;
}

#interactive video {
  width:100%; border-radius:15px;
}

select {
  background:var(--card); color:var(--text);
  padding:5px; border-radius:5px;
  border:1px solid var(--p);
}
</style>
</head>

<body>

<div class="header">
  <select id="langSelect" onchange="changeLang()">
    <option value="es">Espa침ol</option>
    <option value="en">English</option>
  </select>
  <div style="cursor:pointer;font-size:22px;" onclick="toggleTheme()">游깿</div>
</div>

<div class="dashboard">
  <h3 id="txt-prog">游늵 Mi Progreso</h3>
  <canvas id="waterChart" width="100" height="100"></canvas>
  <div id="waterStatus" style="font-weight:bold;font-size:1.2rem;">
    0.00 / 2.5 L
  </div>
</div>

<div class="action-grid">
  <div class="action-card" onclick="addWater()">
    <span id="txt-addwater">游눦 + Agua</span>
  </div>
  <div class="action-card" onclick="showPanel('scan')">
    <span id="txt-scanbtn">游닞 Escanear</span>
  </div>
</div>

<div id="scan" class="panel">
  <h3 id="txt-scantitle">Esc치ner de Alimentos</h3>
  <div id="interactive"></div>
  <button class="btn" id="txt-cambtn" onclick="startScanner()">
    Activar C치mara
  </button>
  <div id="scanResult" style="margin-top:15px;padding:10px;border-radius:10px;"></div>
</div>

<script>
/* =========================
   I18N
========================= */
const i18n = {
  es: {
    prog:"游늵 Mi Progreso", addwater:"游눦 + Agua", scanbtn:"游닞 Escanear",
    scantitle:"Esc치ner de Alimentos", cambtn:"Activar C치mara",
    newday:"춰Buen d칤a! Tu contador ha sido reiniciado.",
    grades:{A:"Excelente",B:"Bueno",C:"Moderado",D:"Malo",E:"Muy Malo"},
    advice:{A:"Muy saludable",B:"Buena opci칩n",C:"Consumo ocasional",D:"Alto en az칰car/grasa",E:"Ultra procesado"}
  },
  en: {
    prog:"游늵 My Progress", addwater:"游눦 + Water", scanbtn:"游닞 Scan Food",
    scantitle:"Food Scanner", cambtn:"Start Camera",
    newday:"Good morning! Your counter has been reset.",
    grades:{A:"Excellent",B:"Good",C:"Moderate",D:"Bad",E:"Very Bad"},
    advice:{A:"Very healthy",B:"Good choice",C:"Occasional intake",D:"High sugar/fat",E:"Ultra processed"}
  }
};

/* =========================
   STATE
========================= */
const state = {
  water: Number(localStorage.getItem('water')) || 0,
  theme: localStorage.getItem('theme') || 'light',
  lang: localStorage.getItem('lang') || 'es',
  lastDate: localStorage.getItem('lastDate') || new Date().toDateString()
};

function saveState(){
  Object.keys(state).forEach(k =>
    localStorage.setItem(k,state[k])
  );
}

/* =========================
   NEW DAY CHECK
========================= */
function checkNewDay(){
  const today = new Date().toDateString();
  if(state.lastDate !== today){
    state.water = 0;
    state.lastDate = today;
    saveState();
    alert(i18n[state.lang].newday);
  }
}

/* =========================
   UI
========================= */
function changeLang(){
  state.lang = langSelect.value;
  saveState();
  updateUI();
}

function updateUI(){
  const t = i18n[state.lang];
  txt-prog.innerText = t.prog;
  txt-addwater.innerText = t.addwater;
  txt-scanbtn.innerText = t.scanbtn;
  txt-scantitle.innerText = t.scantitle;
  txt-cambtn.innerText = t.cambtn;
  langSelect.value = state.lang;
  updateWaterUI();
}

function showPanel(id){
  document.querySelectorAll('.panel').forEach(p=>p.style.display='none');
  document.getElementById(id).style.display='block';
}

/* =========================
   THEME (FIXED)
========================= */
function toggleTheme(){
  state.theme = state.theme === 'dark' ? 'light' : 'dark';
  if(state.theme === 'dark')
    document.documentElement.setAttribute('data-theme','dark');
  else
    document.documentElement.removeAttribute('data-theme');
  saveState();
}

/* =========================
   CHART
========================= */
const waterChart = new Chart(waterChart.getContext('2d'),{
  type:'doughnut',
  data:{datasets:[{data:[0,100],backgroundColor:['#fff','rgba(255,255,255,.3)'],borderWidth:0}]},
  options:{cutout:'80%',plugins:{legend:{display:false}}}
});

function updateWaterUI(){
  const pct = Math.min((state.water/2.5)*100,100);
  waterChart.data.datasets[0].data=[pct,100-pct];
  waterChart.update();
  waterStatus.innerText = state.water.toFixed(2)+' / 2.5 L';
}

function addWater(){
  state.water = Math.min(state.water + 0.25, 2.5);
  saveState();
  updateWaterUI();
}

/* =========================
   SCANNER (FIXED)
========================= */
function startScanner(){
  Quagga.stop();
  Quagga.offDetected();

  Quagga.init({
    inputStream:{type:"LiveStream",target:"#interactive",constraints:{facingMode:"environment"}},
    decoder:{readers:["ean_reader"]}
  },err=>{
    if(err){
      alert("No se pudo acceder a la c치mara");
      return;
    }
    Quagga.start();
  });

  Quagga.onDetected(async data=>{
    Quagga.stop();
    const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${data.codeResult.code}.json`);
    const json = await res.json();
    if(!json.product) return;

    const grade = (json.product.nutriscore_grade || 'C').toUpperCase();
    const t = i18n[state.lang];
    const colors={A:"#2ecc71",B:"#27ae60",C:"#f1c40f",D:"#e67e22",E:"#e74c3c"};

    scanResult.innerHTML = `
      <div style="border-left:5px solid ${colors[grade]};padding-left:10px;">
        <b>${json.product.product_name||'Producto'}</b><br>
        <span style="color:${colors[grade]}">${t.grades[grade]}</span><br>
        <small>${t.advice[grade]}</small>
      </div>`;
  });
}

/* =========================
   INIT
========================= */
if(state.theme==='dark')
  document.documentElement.setAttribute('data-theme','dark');

checkNewDay();
updateUI();
</script>

</body>
</html>